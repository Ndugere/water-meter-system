{% extends "core/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Billing & Payments{% endblock %}

{% block content %}
<div class="container-fluid py-5" style="background-color:#f5f7fa; min-height:80vh;">

    <!-- Add Bill & Payment Buttons -->
<div class="d-flex justify-content-end mb-3">
    <a href="{% url 'bill_add' %}" class="btn btn-primary me-2">
        <i class="bi bi-plus-circle"></i> Add Bill
    </a>
    <a href="{% url 'payment_add' %}" class="btn btn-success">
        <i class="bi bi-plus-circle"></i> Add Payment
    </a>
</div>


  <!-- KPIs -->
  <div class="row g-3 mb-4 text-center">
    <div class="col-md-3">
      <div class="kpi-card bg-primary text-white rounded-4 p-3 shadow-sm">
        <div class="small">Total Billed</div>
        <div class="fs-5 fw-bold">KSh {{ total_billed|floatformat:2|intcomma }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="kpi-card bg-success text-white rounded-4 p-3 shadow-sm">
        <div class="small">Total Collected</div>
        <div class="fs-5 fw-bold">KSh {{ total_collected|floatformat:2|intcomma }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="kpi-card bg-warning text-dark rounded-4 p-3 shadow-sm">
        <div class="small">Total Due</div>
        <div class="fs-5 fw-bold">KSh {{ total_due|floatformat:2|intcomma }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="kpi-card bg-danger text-white rounded-4 p-3 shadow-sm">
        <div class="small">Unpaid Bills</div>
        <div class="fs-5 fw-bold">{{ unpaid_bills_count|intcomma }}</div>
      </div>
    </div>
  </div>

  <!-- Filter Buttons -->
  <div class="mb-4">
    {% if filter_option == "unpaid" %}
      <a href="{% url 'billing_payments' %}" class="btn btn-outline-secondary">Show All Bills</a>
    {% else %}
      <a href="{% url 'billing_payments' %}?filter=unpaid" class="btn btn-outline-danger">Show Only Unpaid Bills</a>
    {% endif %}
  </div>

  <!-- Bills Table -->
  <h3 class="fw-bold mb-3">ðŸ§¾ Bills</h3>
  <div class="table-responsive mb-5">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>Bill ID</th>
          <th>Customer</th>
          <th>Meter</th>
          <th>Issue Date</th>
          <th>Due Date</th>
          <th>Amount Due (KSh)</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for bill in bills %}
        <tr>
          <td>{{ bill.id }}</td>
          <td>{{ bill.customer.name }}</td>
          <td>{{ bill.reading.meter.serial_number }}</td>
          <td>{{ bill.issue_date }}</td>
          <td>{{ bill.due_date }}</td>
          <td>{{ bill.amount_due|floatformat:2|intcomma }}</td>
          <td>
            {% if bill.is_paid %}
              <span class="badge bg-success">Paid</span>
            {% else %}
              <span class="badge bg-danger">Unpaid</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center text-muted">No bills found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Payments Table -->
  <h3 class="fw-bold mb-3">ðŸ’° Payments</h3>
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>Payment ID</th>
          <th>Bill ID</th>
          <th>Customer</th>
          <th>Amount Paid (KSh)</th>
          <th>Payment Date</th>
          <th>Reference</th>
        </tr>
      </thead>
      <tbody>
        {% for payment in payments %}
        <tr>
          <td>{{ payment.id }}</td>
          <td>{{ payment.bill.id }}</td>
          <td>{{ payment.bill.customer.name }}</td>
          <td>{{ payment.amount|floatformat:2|intcomma }}</td>
          <td>{{ payment.payment_date }}</td>
          <td>{{ payment.reference_number }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted">No payments found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<!-- Styles -->
<style>
  .kpi-card { transition: transform .2s ease; }
  .kpi-card:hover { transform: translateY(-4px); }

  table th, table td { vertical-align: middle !important; }
</style>
{% endblock %}
